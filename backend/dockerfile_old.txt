# =========================
# Stage 1: Build dependencies
# =========================
#FROM python:3.12-slim AS builder
#WORKDIR /app

# Install system deps for builds
#RUN apt-get update && apt-get install -y --no-install-recommends \
 #   build-essential gcc git curl libffi-dev libssl-dev \
  #  && rm -rf /var/lib/apt/lists/*

# Copy requirements and install to /opt/python
#COPY requirements.txt .
#RUN pip install --upgrade pip
#RUN pip install --target=/opt/python --no-cache-dir -r requirements.txt

# =========================
# Stage 2: Lambda + Local Runtime
# =========================
#FROM public.ecr.aws/lambda/python:3.12

# Copy dependencies
#COPY --from=builder /opt/python /opt/python

# Set PYTHONPATH
#ENV PYTHONPATH=/var/task/app:/opt/python:${PYTHONPATH:-}

# Copy app code
#COPY app/ /var/task/app/
#COPY handler.py /var/task/

# Dual-mode entrypoint (Lambda or local)
#ENTRYPOINT ["/usr/bin/env"]
#CMD ["bash", "-c", "if [ \"$ENV\" = 'local' ]; then python /var/task/handler.py; else /var/runtime/bootstrap; fi"]
# =========================
# Stage 1: Build dependencies
# =========================
FROM python:3.12-slim AS builder
WORKDIR /app

# Install system deps for builds
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential gcc git curl libffi-dev libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install to /opt/python
COPY requirements.txt .
RUN pip install --upgrade pip
RUN pip install --target=/opt/python --no-cache-dir -r requirements.txt

# =========================
# Stage 2: Lambda Runtime
# =========================
FROM public.ecr.aws/lambda/python:3.12

# Copy dependencies from builder
COPY --from=builder /opt/python /opt/python

# Set PYTHONPATH
ENV PYTHONPATH=/var/task/app:/opt/python:${PYTHONPATH:-}

# Copy app code
COPY app/ /var/task/app/
COPY handler.py /var/task/

# For Lambda, CMD must point to Python handler
# Format: ["file_name.function_name"]
CMD ["handler.lambda_handler"]
